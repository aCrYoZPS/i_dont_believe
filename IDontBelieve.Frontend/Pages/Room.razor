@page "/room/{RoomId:int}"
@inject GameHubService GameService
@inject GameService RoomService
@inject NavigationManager Navigation
@using IDontBelieve.Frontend.Services
@implements IDisposable
@using IDontBelieve.Core.DTOs
@using IDontBelieve.Core.Models

<div class="container-fluid mt-4">
    @if (GameService.CurrentRoom == null)
    {
        <p>Loading room...</p>
    }
    else if (RoomService.CurrentState == null)
    {
        <div class="row">
            <div class="col-md-8">
                <div class="border rounded p-3 h-100">
                    <h4 class="text-center mb-3">Waiting for game start...</h4>
                    <p class="text-muted text-center">Host needs to press "Start Game".</p>
                </div>
            </div>

            <div class="col-md-4">
                <div class="border rounded p-3 h-100 d-flex flex-column">
                    <h5>@GameService.CurrentRoom.Name</h5>
                    <p>Status: <strong>@GameService.CurrentRoom.Status</strong></p>
                    <p>Players: <strong>@GameService.CurrentRoom.CurrentPlayerCount / @GameService.CurrentRoom.MaxPlayers</strong></p>

                    <button class="btn btn-danger btn-sm" @onclick="LeaveRoom">Leave</button>

                    <hr />
                    <h6>Players</h6>
                    <ul class="list-group mb-3">
                        @foreach (var p in GameService.CurrentRoom.Players)
                        {
                            <li class="list-group-item d-flex justify-content-between">
                                @p.Username
                                @if (p.IsHost)
                                {
                                    <span class="badge bg-warning">Host</span>
                                }
                            </li>
                        }
                    </ul>

                    <div class="mt-auto">
                        @if (GameService.CurrentRoom.Status == "Waiting"
                             && GameService.CurrentRoom.Players.Any(p => p.UserId == userId && p.IsHost))
                        {
                            <button class="btn btn-success w-100" @onclick="StartGame">
                                Start Game
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        var game = RoomService.CurrentState;

        <div class="row">

            <!-- LEFT: GAME FIELD -->
            <div class="col-md-8">
                <div class="border rounded p-3 h-100">
                    <h4 class="text-center mb-3">Game Field</h4>

                    @if (game.Phase != GamePhase.Playing)
                    {
                        <div class="text-center text-muted">
                            Waiting for game start...
                        </div>
                    }
                    else
                    {
                        <div class="table-wrapper">

                            <!-- OPPONENTS -->
                            <div class="opponents-list">
                                @foreach (var p in game.Players.Where(p => p.UserId != userId))
                                {
                                    var isTurn = p.UserId == game.CurrentPlayerId;

                                    <div class="opponent-card @(isTurn ? "active-turn" : "")">
                                        @if (isTurn)
                                        {
                                            <div class="turn-label">THINKING...</div>
                                        }

                                        <div class="opponent-name">@p.UserName</div>

                                        <div class="opponent-cards-mini">
                                            @for (int i = 0; i < p.CardCount; i++)
                                            {
                                                <span class="mini-card">🂠</span>
                                            }
                                            <span class="count-badge">@p.CardCount</span>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- FIELD -->
                            <div class="game-field">
                                <div class="field-label">Game Field</div>
                                <div class="played-cards"></div>
                            </div>

                            <!-- PLAYER AREA -->
                            @{
                                var me = game.Players.FirstOrDefault(p => p.UserId == userId);
                                var hand = me?.Hand ?? new List<Card>();
                                var myTurn = me != null && game.CurrentPlayerId == userId && hand.Count > 0;
                            }

                            <div class="player-interface @(myTurn ? "my-turn-active" : "")">
                                @if (myTurn)
                                {
                                    <div class="turn-label main-label">YOUR TURN</div>
                                }

                                <div class="current-player-area">
                                    <div class="player-badge">You: @(me?.UserName ?? "Unknown")</div>

                                    <div class="my-cards-flex">
                                        @if (hand.Count == 0)
                                        {
                                            <div class="text-muted mb-2">No cards yet. Start the game.</div>
                                            @if (IsHost)
                                            {
                                                <button class="btn btn-success btn-sm" @onclick="StartGame">
                                                    Start game
                                                </button>
                                            }
                                        }
                                        else
                                        {
                                            @for (int i = 0; i < hand.Count; i++)
                                            {
                                                var idx = i;
                                                <div class="card-ui @(selectedCards.Contains(idx) ? "selected" : "")"
                                                     @onclick="() => SelectCard(idx)">
                                                    🂡
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>

                                <div class="controls-column">
                                    <button class="btn-game move"
                                            disabled="@(selectedCards.Count == 0 || !myTurn)"
                                            @onclick="HandleMove">
                                        Make a move
                                    </button>

                                    <button class="btn-game believe"
                                            disabled="@(myTurn)"
                                            @onclick="HandleBelieve">
                                        I believe
                                    </button>

                                    <button class="btn-game doubt"
                                            disabled="@(myTurn)"
                                            @onclick="HandleDoubt">
                                        I don't believe
                                    </button>
                                </div>
                            </div>

                        </div>
                    }
                </div>
            </div>

            <!-- RIGHT: ROOM INFO -->
            <div class="col-md-4">
                <div class="border rounded p-3 h-100 d-flex flex-column">

                    <h5>@GameService.CurrentRoom.Name</h5>

                    <p>Status: <strong>@GameService.CurrentRoom.Status</strong></p>

                    <p>
                        Players:
                        <strong>
                            @GameService.CurrentRoom.CurrentPlayerCount /
                            @GameService.CurrentRoom.MaxPlayers
                        </strong>
                    </p>

                    <button class="btn btn-danger btn-sm" @onclick="LeaveRoom">
                        Leave
                    </button>

                    <hr />

                    <h6>Players</h6>
                    <ul class="list-group mb-3">
                        @foreach (var p in GameService.CurrentRoom.Players)
                        {
                            <li class="list-group-item d-flex justify-content-between">
                                @p.Username
                                @if (p.IsHost)
                                {
                                    <span class="badge bg-warning">Host</span>
                                }
                            </li>
                        }
                    </ul>

                    <div class="mt-auto">
                        @if (GameService.CurrentRoom.Status == "Waiting"
                             && GameService.CurrentRoom.Players.Any(p => p.UserId == userId && p.IsHost))
                        {
                            <button class="btn btn-success w-100" @onclick="StartGame">
                                Start Game
                            </button>
                        }
                    </div>
                </div>
            </div>

        </div>
    }
</div>

@code {

    [Parameter] public int RoomId { get; set; }

    private int userId;
    private HashSet<int> selectedCards = new();

    private bool IsHost =>
        GameService.CurrentRoom?.Players.Any(p => p.UserId == userId && p.IsHost) == true;

    protected override async Task OnInitializedAsync()
    {
        GameService.OnCurrentRoomUpdated += StateHasChanged;
        RoomService.OnGameStateUpdated += StateHasChanged;

        await GameService.ConnectAsync();
        await GameService.JoinRoomAsync(RoomId);

        userId = await GameService.GetUserId();

        await RoomService.JoinGameAsync(RoomId, userId, await GameService.GetUsername());
        await RoomService.LoadGameStateAsync(RoomId);

        await AutoStartIfHostAsync();
    }

    private async Task StartGame()
    {
        await RoomService.StartGameAsync(RoomId);
        await RoomService.LoadGameStateAsync(RoomId);
    }

    private async Task LeaveRoom()
    {
        await GameService.LeaveRoomAsync(RoomId);
        Navigation.NavigateTo("/rooms");
    }

    private void SelectCard(int index)
    {
        if (selectedCards.Contains(index))
            selectedCards.Remove(index);
        else
            selectedCards.Add(index);
    }

    private async Task HandleMove()
    {
        var me = RoomService.CurrentState!
            .Players.First(p => p.UserId == userId);

        var hand = me.Hand ?? new List<Card>();
        if (selectedCards.Count == 0) return;

        var cards = selectedCards
            .Where(i => i >= 0 && i < hand.Count)
            .Select(i => hand[i])
            .ToList();

        if (cards.Count == 0) return;

        var move = new GameMoveDto
        {
            Cards = cards,
            ClaimedRank = cards[0].Rank,
            TargetPlayerId = null
        };

        await RoomService.MakeMoveAsync(RoomId, userId, move);
        selectedCards.Clear();
    }

    private async Task HandleBelieve()
    {
        await RoomService.BelieveOrNotAsync(RoomId, userId, true);
    }

    private async Task HandleDoubt()
    {
        await RoomService.BelieveOrNotAsync(RoomId, userId, false);
    }

    private async Task AutoStartIfHostAsync()
    {
        if (IsHost &&
            GameService.CurrentRoom?.Status == "Waiting" &&
            GameService.CurrentRoom.Players.Count >= 2)
        {
            await RoomService.StartGameAsync(RoomId);
            await RoomService.LoadGameStateAsync(RoomId);
            return;
        }

        // Если игра уже "Playing", но у всех пустые руки, попробуем снова стартовать (на случай сбоя раздачи)
        if (IsHost &&
            GameService.CurrentRoom?.Status == "InProgress" &&
            RoomService.CurrentState?.Players.All(p => (p.Hand?.Count ?? 0) == 0) == true)
        {
            await RoomService.StartGameAsync(RoomId);
            await RoomService.LoadGameStateAsync(RoomId);
        }
    }

    public void Dispose()
    {
        GameService.OnCurrentRoomUpdated -= StateHasChanged;
        RoomService.OnGameStateUpdated -= StateHasChanged;
    }
}
