@page "/leaderboard"
@using IDontBelieve.Core.Models
@using IDontBelieve.Frontend.Services
@inject ILeaderboardHubService LeaderboardService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Leaderboard - IDontBelieve</PageTitle>

<div class="leaderboard-container">
    <header class="lb-header">
        <div class="lb-info">
            <h1><span class="emoji">🏆</span> Leaderboard</h1>
            <p>Top players by rating — updates in real-time</p>
            @if (leaderboard != null)
            {
                <div class="last-update">
                    Updated: <strong>@leaderboard.UpdatedAt.ToLocalTime().ToString("HH:mm:ss")</strong>
                    @if (isConnected) { <span class="live-tag">LIVE</span> }
                </div>
            }
        </div>
        
        <div class="lb-controls">
            <div class="status @(isConnected ? "online" : "offline")">
                <i></i> @(isConnected ? "Connected" : "Disconnected")
            </div>
            <label class="toggle">
                <input type="checkbox" @bind="autoRefresh" @oninput="OnAutoRefreshToggled"/>
                <span class="slider"></span> Auto-refresh
            </label>
        </div>
    </header>

    @if (isLoading && leaderboard == null)
    {
        <div class="lb-state-box loading">
            <div class="spinner"></div>
            <p>Loading leaderboard...</p>
        </div>
    }

    @if (!isLoading && leaderboard == null && !isConnected)
    {
        <div class="lb-state-box error">
            <div class="error-icon">⚠️</div>
            <h3>Connection Lost</h3>
            <p>Unable to connect to the leaderboard service.</p>
            <button @onclick="Reconnect">Reconnect</button>
        </div>
    }

    @if (leaderboard != null)
    {
        <main class="lb-content">
            <div class="lb-list">
                <button @onclick="RefreshLeaderboard">Refresh Leaderboard</button>
                    <div class="controls-section">
                        <label class="count-selector">
                            Show:
                            <select @bind="itemsCount" @oninput="OnCountChanged">
                                <option value="10">Top 10</option>
                                <option value="25">Top 25</option>
                                <option value="50">Top 50</option>
                                <option value="100">Top 100</option>
                            </select>
                        </label>
                    </div>
                @foreach (var user in leaderboard.Users)
                {
                    <div class="lb-card @GetRankClass(user.Rank) @(user.Rank <= 3 ? "podium" : "")">
                        <div class="rank-badge">
                            @if (user.Rank <= 3)
                                {
                                    <div class="medal">
                                        @(user.Rank == 1 ? "🥇" : user.Rank == 2 ? "🥈" : "🥉")
                                    </div>
                                }
                            else
                            {
                                <span class="number">#@user.Rank</span>
                            }
                        </div>

                        <div class="user-info">
                            <span class="name">@user.UserName</span>
                            <div class="mini-stats">
                                <span>Rating: <b>@user.Rating</b></span>
                                <span>Games: <b>@user.GamesPlayed</b></span>
                            </div>
                        </div>

                        <div class="winrate-section">
                            <div class="progress-wrapper">
                                <div class="bar" style="width: @(user.WinRate * 100)%; background: @GetWinRateColor(user.WinRate)"></div>
                            </div>
                            <span class="percent">@(user.WinRate.ToString("P1"))</span>
                        </div>
                    </div>
                }
            </div>

            @if (!leaderboard.Users.Any())
            {
                <div class="lb-state-box empty">
                    <div class="empty-icon">📊</div>
                    <h3>No Players Yet</h3>
                    <p>Be the first to join the leaderboard!</p>
                </div>
            }
        </main>

        <footer class="lb-footer">
            <div class="stat-box">
                <span class="val">@leaderboard.Users.Count</span>
                <span class="lab">Players</span>
            </div>
            <div class="stat-box">
                <span class="val text-gold">@leaderboard.Users.Max(u => u.Rating)</span>
                <span class="lab">Top Rating</span>
            </div>
            <div class="stat-box">
                <span class="val text-info">@(leaderboard.Users.Average(u => u.WinRate).ToString("P0"))</span>
                <span class="lab">Avg Win Rate</span>
            </div>
            <div class="stat-box">
                <span class="val text-primary">@leaderboard.Users.Sum(u => u.GamesPlayed)</span>
                <span class="lab">Total Games</span>
            </div>
        </footer>
    }
</div>

@code {
    private LeaderboardUpdate? leaderboard;
    private bool isLoading = true;
    private bool isConnected = false;
    private bool autoRefresh = true;
    private int itemsCount = 10;
    private Timer? autoRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        LeaderboardService.OnLeaderboardUpdated += OnLeaderboardUpdated;
        await InitializeConnection();
        await LoadLeaderboard();
        StartAutoRefresh();
    }

    private async Task InitializeConnection()
    {
        try
        {
            await LeaderboardService.ConnectAsync();
            await LeaderboardService.SubscribeToUpdatesAsync();
            isConnected = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to connect to hub: {ex.Message}");
            isConnected = false;
        }
    }

    private async Task LoadLeaderboard()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            leaderboard = await LeaderboardService.GetLeaderboardAsync(itemsCount);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load leaderboard: {ex.Message}");
            isConnected = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshLeaderboard()
    {
        await LoadLeaderboard();
    }

    private async Task Reconnect()
    {
        await InitializeConnection();
        if (isConnected)
        {
            await LoadLeaderboard();
        }
    }

    private void OnLeaderboardUpdated(LeaderboardUpdate update)
    {
        leaderboard = update;
        StateHasChanged();

        // Show notification for new updates
        if (autoRefresh)
        {
            _ = JSRuntime.InvokeVoidAsync("console.log", "Leaderboard updated via SignalR");
        }
    }

    private void OnAutoRefreshToggled(ChangeEventArgs e)
    {
        autoRefresh = (bool)e.Value!;
        if (autoRefresh)
        {
            StartAutoRefresh();
        }
        else
        {
            StopAutoRefresh();
        }
    }

    private async void OnCountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newCount))
        {
            itemsCount = newCount;
            await LoadLeaderboard();
        }
    }

    private void StartAutoRefresh()
    {
        autoRefreshTimer?.Dispose();
        if (autoRefresh)
        {
            autoRefreshTimer = new Timer(async _ =>
            {
                if (isConnected && autoRefresh)
                {
                    await InvokeAsync(async () => { await LoadLeaderboard(); });
                }
            }, null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(1));
        }
    }

    private void StopAutoRefresh()
    {
        autoRefreshTimer?.Dispose();
        autoRefreshTimer = null;
    }

    private string GetRankClass(int rank)
    {
        return rank switch
        {
            1 => "rank-1",
            2 => "rank-2",
            3 => "rank-3",
            _ => ""
        };
    }

    private string GetWinRateColor(double winRate)
    {
        return winRate switch
        {
            >= 0.7 => "#10b981", // Green
            >= 0.5 => "#3b82f6", // Blue
            >= 0.3 => "#f59e0b", // Yellow
            _ => "#ef4444" // Red
        };
    }

    public async ValueTask DisposeAsync()
    {
        LeaderboardService.OnLeaderboardUpdated -= OnLeaderboardUpdated;
        StopAutoRefresh();
        await LeaderboardService.DisconnectAsync();
    }

}
